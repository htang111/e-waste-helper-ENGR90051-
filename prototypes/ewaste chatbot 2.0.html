<!doctype html>
<html lang="en-au">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>City of Melbourne ‚Äî E‚ÄëWaste Helper</title>
  <style>
    :root{ --bg:#ffffff; --card:#ffffff; --ink:#111111; --muted:#444444;
      --accent:#f5b7c8; --line:#e9e9e9; --pill:#eef2f7; }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    header{padding:24px 16px;text-align:center;background:linear-gradient(180deg,#fde8ef 0,#fff 100%);border-bottom:1px solid var(--line)}
    header h1{margin:0 0 6px;font-weight:800;letter-spacing:.2px}
    header p{margin:0;color:#333}
    main{max-width:980px;margin:0 auto;padding:12px 16px 80px}
    .grid{display:grid;gap:16px}
    @media (min-width:880px){ .grid.cols-2{grid-template-columns: 2fr 1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 18px rgba(17,17,17,.06);padding:18px}
    .chatwrap{display:flex;flex-direction:column;gap:12px}
    .messages{display:flex;flex-direction:column;gap:10px;max-height:62vh;overflow:auto;padding-right:4px}
    .msg{display:flex}
    .bubble{padding:10px 12px;border-radius:14px;max-width:85%}
    .ai .bubble{background:#fff6fa;border:1px solid var(--line)}
    .me{justify-content:flex-end}
    .me .bubble{background:#f7f8fb;border:1px solid var(--line)}
    .slots{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .slot{padding:10px;border-radius:12px;background:#fff;border:1px solid var(--line)}
    .slot strong{display:block;font-size:12px;color:#666}
    .slot .value{margin-top:2px}
    .hint{color:#555;font-size:.95rem}
    .row{display:flex;gap:8px;align-items:center}
    .row input[type="text"]{flex:1;padding:12px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink)}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;color:#111;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{border-color:var(--accent);box-shadow:0 0 0 2px rgba(245,183,200,.25) inset}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#ffcee0);border-color:transparent;color:#111}
    label.filebtn{border:1px dashed var(--line);padding:10px 12px;border-radius:12px;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
    input[type="file"]{display:none}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--pill);border:1px solid var(--line);font-size:.8rem;color:#555}
    .site{padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;margin:6px 0}
    .site a{color:#d63b82;text-decoration:none}
    .footer{color:#555;font-size:.9rem;margin-top:8px}
    .tiny{font-size:12px;color:#666}
    .safety-list{margin:8px 0 0 16px; padding:0}
    .safety-list li{margin:6px 0}
    .strong{font-weight:700}
    .imgthumb{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px 10px;background:#fff}
    .imgthumb img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
  </style>
</head>
<body>
  <header>
    <h1>City of Melbourne ‚Äî E‚ÄëWaste Helper</h1>
    <p>Classify items, size them, verify your CoM suburb, and find the nearest drop‚Äëoff. Images supported.</p>
  </header>

  <main class="grid cols-2">
    <section class="card">
      <div class="chatwrap">
        <div class="messages" id="log"></div>
        <div class="slots" id="slots"></div>
        <div class="row">
          <input id="input" type="text" placeholder="Type an item (e.g., ‚Äòold phone, small, Parkville‚Äô)‚Ä¶" />
          <button id="send" class="btn primary">Send</button>
          <label class="filebtn" title="Upload a photo">
            <input id="file" type="file" accept="image/*" /> üì∑ Image
          </label>
        </div>
        <div class="tiny">After results we‚Äôll reuse your suburb. Start a new item any time (e.g., ‚Äúgraphics card‚Äù).</div>
      </div>
    </section>

    <aside class="card">
      <div><strong>Status</strong> <span id="status" class="pill">Ready</span></div>
      <button id="locate" class="btn" style="margin-top:8px">Use my location</button>
      <div id="locHint" class="tiny"></div>
      <hr />
      <div><strong>Safety quick guide</strong></div>
      <ul class="safety-list">
        <li><strong>Never put e‚Äëwaste in household or recycling bins.</strong> Use drop‚Äëoff points only.</li>
        <li><strong>Batteries & vapes:</strong> tape terminals, place in a clear bag. If damaged, swollen or hot, isolate and contact the site first.</li>
        <li><strong>Phones & computers:</strong> back up and <em>factory‚Äëreset</em>; remove SIM/SD cards.</li>
        <li><strong>Pack safely:</strong> keep devices dry; avoid crushing; don‚Äôt mix loose batteries with metal objects.</li>
        <li>More info: <a href="https://www.melbourne.vic.gov.au/a-z-waste-guide" target="_blank" rel="noopener">A‚ÄìZ Waste Guide</a> ¬∑ 
        <a href="https://www.melbourne.vic.gov.au/e-waste-and-chemicals" target="_blank" rel="noopener">E‚ÄëWaste &amp; Chemicals</a></li>
      </ul>
    </aside>
  </main>

<script>
const WORKER_URL = "https://ewasteworker.haydenvltang.workers.dev";

// --- CoM suburbs + sample locations ---
const COM_SUBURBS = ['Melbourne','Docklands','Southbank','West Melbourne','North Melbourne','Carlton','East Melbourne','Parkville','Kensington','South Yarra'];
const LOCATIONS = [
  { name:'Melbourne Library (CBD)', address:'253 Flinders Ln, Melbourne VIC 3000', types:['batteries','phones','cables','appliance'], suburb:'Melbourne', lat:-37.8165, lng:144.9652 },
  { name:'Library at The Dock', address:'107 Victoria Harbour Promenade, Docklands VIC 3008', types:['batteries','phones','cables'], suburb:'Docklands', lat:-37.8215, lng:144.9436 },
  { name:'Dynon Rd Transfer Station (staffed)', address:'437 Dynon Rd, West Melbourne VIC 3003', types:['batteries','phones','computers','cables','tv','printer','microwave','appliance'], suburb:'West Melbourne', lat:-37.8064, lng:144.9148 },
];

// --- State ---
const state = { slots: { item:null, size:null, suburb:null }, suburbLocked:false, history: [], presentedKey:null };

// --- UI helpers ---
const el = id=>document.getElementById(id);
const logEl = el('log'); const slotsEl = el('slots'); const statusEl = el('status');
const inputEl = el('input'); const fileEl = el('file');

function addMsg(who, html){ const wrap = document.createElement('div'); wrap.className='msg '+who; const bubble = document.createElement('div'); bubble.className='bubble'; bubble.innerHTML=html; wrap.appendChild(bubble); logEl.appendChild(wrap); logEl.scrollTop = logEl.scrollHeight; }
function toTitle(s){ if(!s) return ''; return s.replace(/\b\w+/g, t=> t==='tv' ? 'TV' : t.charAt(0).toUpperCase()+t.slice(1)); }
function capWord(s){ return !s ? '' : s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(); }
function fmtSlot(key, val){
  if(!val) return '(missing)';
  if(key==='item') return '<span class="strong">'+toTitle(val)+'</span>';
  if(key==='suburb') return '<span class="strong">'+toTitle(val)+'</span>';
  if(key==='size') return '<span class="strong">'+capWord(val)+'</span>';
  return val;
}
function renderSlots(){ 
  const s=state.slots; slotsEl.innerHTML=''; 
  [['Item (category)','item'],['Size','size'],['Suburb','suburb']].forEach(([label,key])=>{ 
    const div=document.createElement('div'); div.className='slot'; const v = fmtSlot(key, s[key]); 
    div.innerHTML = `<strong>${label}</strong><div class="value">${v}</div>`; 
    slotsEl.appendChild(div); 
  }); 
}
function gmapsLink(lat,lng,name){ const q=encodeURIComponent(`${name} @ ${lat},${lng}`); return `https://www.google.com/maps/search/?api=1&query=${q}`; }
function prettyCategory(cat){ return '<span class="strong">'+toTitle(cat)+'</span>'; }
function prettyItemSizeSuburb(){ 
  const s=state.slots; 
  const sizeTxt = s.size ? '<span class="strong">'+capWord(s.size)+'</span>' : '';
  const suburbTxt = s.suburb ? '<span class="strong">'+toTitle(s.suburb)+'</span>' : '';
  return `${prettyCategory(s.item)}${sizeTxt? ' ('+sizeTxt+')':''} ‚Äî ${suburbTxt}`; 
}
function nearbySites(category, suburb){ const accepts=LOCATIONS.filter(x=>x.types.includes(category)); const sorted=accepts.sort((a,b)=>{ const aScore=(a.suburb===suburb?0:1)+(a.name.includes('Transfer Station')?0.3:0.6); const bScore=(b.suburb===suburb?0:1)+(b.name.includes('Transfer Station')?0:0.3); return aScore - bScore; }); return sorted.slice(0,4); }
function safetyBlurb(category,size){ let lines=[]; if(['batteries','phones','computers'].includes(category)) lines.push('Lithium items: tape terminals, bag separately; never place in household or recycling bins.'); if(category==='computers'||category==='phones') lines.push('Back up and factory‚Äëreset devices; remove SIM/SD cards.'); if(size==='large') lines.push('Bulky items: use a staffed drop‚Äëoff (e.g., Dynon Rd) or book a free hard‚Äëwaste collection.'); return lines.join(' '); }
function linksFooter(){ return `<div class="footer"><a href="https://cityofmelbourne-hardwaste.cleanaway.com.au/" target="_blank" rel="noopener"><strong>Free hard‚Äëwaste booking</strong></a></div>`; }

// --- Alias map (sample; expand as desired) ---
function escapeRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
const ALIAS_TABLE = [
  { aliases:['xbox controller','controller','gamepad','joy-con','dualsense'], category:'computers', size:'small' },
  { aliases:['xbox','ps5','playstation','nintendo switch','console'], category:'computers', size:'medium' },
  { aliases:['phone','iphone','android phone','mobile'], category:'phones', size:'small' },
  { aliases:['battery','aa','aaa','power bank','vape','e-cig'], category:'batteries', size:'small' },
  { aliases:['monitor'], category:'computers', size:'medium' },
  { aliases:['router','modem','mesh'], category:'computers', size:'small' },
  { aliases:['hdmi','usb cable','charger','power cord'], category:'cables', size:'small' },
  { aliases:['tv','television','oled tv','lcd tv','plasma tv','smart tv','flat screen','flatscreen'], category:'tv', size:'large' },
  { aliases:['printer','scanner','copier','mfp'], category:'printer', size:'medium' },
  { aliases:['microwave','convection microwave'], category:'microwave', size:'large' },
  { aliases:['air fryer','toaster oven','kettle','toaster','vacuum','coffee machine'], category:'appliance', size:'medium' }
];
const KEYWORDS = ALIAS_TABLE.flatMap(row => row.aliases.map(a => ({ re: new RegExp(`(^|[^a-z0-9])${escapeRegex(a)}([^a-z0-9]|$)`, 'i'), category: row.category, size: row.size })));

// --- VIC suburb/postcode helpers (outside-CoM hint) ---
const VIC_POSTCODE_RE = /\b3\d{3}\b/;
function haversine(aLat,aLng,bLat,bLng){ const R=6371; const toRad=x=>x*Math.PI/180; const dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng); const s1=Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(s1)); }
function nearestComSite(lat,lng){ let best=null; let dBest=Infinity; for(const s of LOCATIONS){ const d=haversine(lat,lng,s.lat,s.lng); if(d<dBest){ dBest=d; best=s; } } return { site: best, km: dBest }; }
async function geocodeVic(query){ const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&addressdetails=1&countrycodes=au&state=Victoria&q=${encodeURIComponent(query + ', Victoria, Australia')}`; const res = await fetch(url, { headers: { 'Accept': 'application/json' } }); if(!res.ok) return null; const arr = await res.json(); if(!Array.isArray(arr) || !arr.length) return null; const r = arr[0]; const a = r.address || {}; const isVic = /victoria/i.test(a.state||'') || /vic/i.test(a.state||''); return { lat: parseFloat(r.lat), lng: parseFloat(r.lon), display: r.display_name, suburb: a.suburb || a.town || a.city || a.village || '', postcode: a.postcode || '', isVic }; }
async function handleVicOutsideCOM(raw){ const t = (raw||'').trim(); const hasPostcode = (t.match(VIC_POSTCODE_RE)||[])[0]; const q = hasPostcode ? hasPostcode : t; try{ const info = await geocodeVic(q); if(!info || !info.isVic) return false; if(info.suburb && COM_SUBURBS.some(s=> s.toLowerCase()===info.suburb.toLowerCase())) return false; const near = nearestComSite(info.lat, info.lng); if(near.site){ addMsg('ai', `I‚Äôve noted <span class="strong">${toTitle(info.suburb || (hasPostcode ? ('VIC ' + hasPostcode) : 'this location'))}</span>, which is outside the City of Melbourne. The closest CoM drop‚Äëoff is <span class="strong">${near.site.name}</span> (${near.km.toFixed(1)} km).`); addMsg('ai', `Please choose a City of Melbourne suburb to continue: <span class="strong">${COM_SUBURBS.join(', ')}</span>.`); } return true; }catch(e){ return false; } }

// --- Text fallbacks (no 'unknown') ---
function fallbackCategoryAndSize(text){ const t=(text||'').toLowerCase();
  if (/(\bbattery\b|power bank|vape|e-?cig|lithium|lipo|li-po|tool battery|ups|sealed lead acid|sla)/i.test(t)) return { item:'batteries', size: /(ups|sealed lead acid|sla|big battery)/i.test(t) ? 'medium' : 'small' };
  if (/(\btv\b|television|plasma|oled tv|lcd tv|led tv|interactive (display|whiteboard))/i.test(t)) return { item:'tv', size:'large' };
  if (/(microwave)/i.test(t)) return { item:'microwave', size:'large' };
  if (/(printer|photocopier|copier|scanner|all-?in-?one|mfp)/i.test(t)) return { item:'printer', size: /(large|copier|mfd)/i.test(t) ? 'large' : 'medium' };
  if (/(cable|lead|charger|power brick|hdmi|usb|ethernet|displayport|vga|dvi|rca|aux|patch)/i.test(t)) return { item:'cables', size:'small' };
  if (/(\bphone\b|iphone|android)/i.test(t)) return { item:'phones', size:'small' };
  if (/(laptop|notebook|desktop|pc|tower|monitor|console|xbox|playstation|nintendo|router|modem|switch\b|nas|gpu|graphics|motherboard|cpu|ram|ssd|hdd|keyboard|mouse|webcam|headphones|earbuds|airpods|smartwatch|fitbit|camera|gopro|drone|apple tv|chromecast|set-?top|nvr|smart speaker|homepod|echo|google home)/i.test(t)) { if (/(monitor|desktop|tower|console|nas)/i.test(t)) return { item:'computers', size:'medium' }; return { item:'computers', size:'small' }; }
  if (/(air fryer|toaster oven|benchtop oven|kettle|toaster|coffee|espresso|mixer|blender|food processor|rice cooker|slow cooker|bread maker|juicer|dehydrator|vacuum|air purifier|humidifier|dehumidifier|fan|heater|evaporative cooler|shaver|trimmer|toothbrush|alarm clock|radio|remote|toy|gadget|lamp|light|bulb)/i.test(t)) return { item:'appliance', size: /(toaster|kettle|shaver|toothbrush|remote|lamp|bulb|toy|gadget)/i.test(t) ? 'small' : 'medium' };
  return { item:'appliance', size:'small' };
}
function classifyFromAliases(text){ const t=(text||'').toLowerCase(); for (const k of KEYWORDS) { if (k.re.test(t)) return { item:k.category, size:k.size }; } return null; }
function applyHeuristicSize(text, item){ const t=(text||'').toLowerCase(); if(['tv','microwave'].includes(item)) return 'large'; if(['printer','computers'].includes(item)) return 'medium'; if(['phones','cables','batteries'].includes(item)) return 'small'; if(/large|very big|huge/.test(t)) return 'large'; if(/small|hand/.test(t)) return 'small'; if(/medium|backpack|monitor|desktop|printer|console/.test(t)) return 'medium'; return null; }

// --- Worker call ---
async function callWorker(userText, imageDataUrl){
  statusEl.textContent='Thinking‚Ä¶';
  const payload={ history: state.history.slice(-6), user_text: userText || '', image: imageDataUrl || null, known_slots: state.slots, suburbs: COM_SUBURBS };
  try{
    const res = await fetch(WORKER_URL + '/classify', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!res.ok) throw new Error(await res.text());
    return await res.json();
  }catch(err){
    addMsg('ai', `<span class="hint">Proxy error: ${(err && err.message) || err}</span>`);
    return null;
  } finally{ statusEl.textContent='Ready'; }
}

// --- Present & flow ---
function presentResults(){
  const s=state.slots;
  const sites=nearbySites(s.item, s.suburb);
  const list = sites.map(x => `<div class="site"><div><strong>${x.name}</strong></div><div>${x.address}</div><div><a href="${gmapsLink(x.lat,x.lng,x.name)}" target="_blank" rel="noopener"><strong>Open in Google Maps</strong></a></div></div>`).join('');
  addMsg('ai', `<div><div><strong>Closest drop‚Äëoff options for ${prettyItemSizeSuburb()}</strong></div>${list || '<div>No matching sites in demo dataset.</div>'}<div class="hint" style="margin-top:8px">${safetyBlurb(s.item,s.size)}</div>${linksFooter()}</div><div style="margin-top:6px">Another item? You can type it or upload a photo ‚Äî I‚Äôll reuse your suburb.</div>`);
  state.presentedKey = s.item + "|" + s.size + "|" + s.suburb;
}

// Only present once per filled triplet
function maybePresentOnce(){
  const s=state.slots;
  if(s.item && s.size && s.suburb){
    const key = s.item + "|" + s.size + "|" + s.suburb;
    if (key !== state.presentedKey){ presentResults(); }
  }
}

function showImagePreview(dataUrl, name='image'){
  addMsg('me', `<div class="imgthumb"><img src="${dataUrl}" alt="Uploaded Image"/><div>${name}</div></div>`);
}

function consumeUserText(text){
  const parts=(text||'').split(',').map(s=>s.trim()).filter(Boolean); 
  const sizeMap={small:'small',medium:'medium',large:'large'};
  for(const p of parts){
    if(sizeMap[p.toLowerCase()]) state.slots.size=sizeMap[p.toLowerCase()];
    else if(COM_SUBURBS.some(x=>x.toLowerCase()===p.toLowerCase())){ state.slots.suburb=toTitle(p); state.suburbLocked=true; }
  }
  const local = classifyFromAliases(text);
  if(local){ if(!state.slots.item) state.slots.item = local.item; if(!state.slots.size) state.slots.size = local.size; }
  if(!state.slots.item){ const fb = fallbackCategoryAndSize(text); state.slots.item = fb.item; if(!state.slots.size) state.slots.size = fb.size; }
  if(state.slots.item && !state.slots.size){ const hs = applyHeuristicSize(text, state.slots.item); state.slots.size = hs || state.slots.size || 'small'; }
}

function mergeModel(model, isImage){
  if(!model){
    if(isImage) addMsg('ai', 'I couldn‚Äôt identify the photo reliably. Please type the item name (e.g., ‚ÄúTV‚Äù).');
    return;
  }
  if(!state.slots.item && model.item && model.item!=='unknown') state.slots.item=model.item;
  if(!state.slots.size && model.size) state.slots.size=model.size;
  if(model.suburb){
    state.slots.suburb=toTitle(model.suburb);
    if(model.suburb_ok) state.suburbLocked=true;
  }

  const vLabel = model.vision_label || model.image_label || model.label;
  if(vLabel){
    addMsg('ai', `I think this is <strong>${toTitle(vLabel)}</strong> ‚Äî if that‚Äôs wrong, please tell me the correct item.`);
    const local = classifyFromAliases(vLabel) || fallbackCategoryAndSize(vLabel);
    if(!state.slots.item) state.slots.item = local.item;
    if(!state.slots.size) state.slots.size = local.size || applyHeuristicSize(vLabel, local.item) || state.slots.size || 'small';
  }
  // Suppress worker's extra confirmation to avoid duplicates
  // if(model.confirmation) addMsg('ai', model.confirmation);

  renderSlots();
  maybePresentOnce();
}

// ---- Main chat flow ----
addMsg('ai','Hello. Upload a photo or type your item, size (Small/Medium/Large), and City of Melbourne suburb ‚Äî in any order.');
renderSlots();

async function handleSubmit(rawText, imageDataUrl){
  const text=(rawText||'').trim();
  if(!text && !imageDataUrl) return;
  if(text) addMsg('me', text);

  // VIC suburb/postcode hint (non-blocking)
  await handleVicOutsideCOM(text);

  // For text, do local parsing first
  if(text){
    // New item detection: if text contains a known keyword, clear prior item/size and reset presentedKey
    const t=text.toLowerCase(); const hit = KEYWORDS.some(k=>k.re.test(t));
    if(hit){ state.slots.item=null; state.slots.size=null; state.presentedKey=null; }
    consumeUserText(text);
  }

  // For images, show preview then call worker; don't auto-guess on error
  let model = null;
  if(imageDataUrl){ showImagePreview(imageDataUrl, 'Uploaded Image'); model = await callWorker(text, imageDataUrl); mergeModel(model, true); }
  else if(!state.slots.suburb || !state.suburbLocked){ model = await callWorker(text, null); mergeModel(model, false); }

  // Final guarantees: only default size when the user typed text (not images)
  if(!state.slots.item && text){ const fb=fallbackCategoryAndSize(text); state.slots.item=fb.item; if(!state.slots.size) state.slots.size=fb.size; }
  if(!state.slots.size && text) state.slots.size='small';

  // Ask for any missing slot
  const missing=[];
  if(!state.slots.item) missing.push('item/category');
  if(!state.slots.size) missing.push('size (Small/Medium/Large)');
  if(!state.slots.suburb) missing.push('City of Melbourne suburb');
  renderSlots();
  if(missing.length){
    addMsg('ai','Please provide: ' + missing.join(', ') + '.');
    return;
  }

  maybePresentOnce();
}

document.getElementById('send').addEventListener('click',()=>handleSubmit(inputEl.value,null).then(()=>{ inputEl.value=''; }));
inputEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter') document.getElementById('send').click(); });
fileEl.addEventListener('change', async (e)=>{ const file=e.target.files[0]; if(!file) return; const url=await resizeImage(file, 1024); await handleSubmit('', url); e.target.value=''; });

document.getElementById('locate').addEventListener('click', async ()=>{
  await useMyLocation();
  // After geolocation, if all slots are now filled, present immediately
  maybePresentOnce();
  if(!state.slots.suburb) addMsg('ai','If you share your suburb or VIC postcode (e.g., 3000‚Äì3999), I‚Äôll show the nearest City of Melbourne drop‚Äëoff and continue.');
});

// --- Geolocation utility ---
async function useMyLocation(){ if (!navigator.geolocation) { el('locHint').textContent = "Geolocation isn‚Äôt supported in this browser."; return; } el('locHint').textContent = "Locating‚Ä¶"; el('locate').disabled = true; const getPos = () => new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 15000 })); try { const pos = await getPos(); const { latitude: lat, longitude: lng } = pos.coords; const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=14&addressdetails=1`; const res = await fetch(url, { headers: { 'Accept': 'application/json' } }); if (!res.ok) throw new Error(`Reverse-geocode failed: ${await res.text()}`); const data = await res.json(); const a = data.address || {}; const candidates = [a.suburb, a.neighbourhood, a.city_district, a.town, a.city, a.village, a.state_district].filter(Boolean); const match = candidates.map(c => c.trim()).map(c => (/(cbd|central business district)/i.test(c) ? 'Melbourne' : c)).find(c => COM_SUBURBS.some(s => s.toLowerCase() === c.toLowerCase())); if (match) { const proper = COM_SUBURBS.find(s => s.toLowerCase() === match.toLowerCase()); const prev = state.slots.suburb; state.slots.suburb = proper; state.suburbLocked = true; renderSlots(); addMsg('ai', `Location detected: <strong>${proper}</strong>.`); if (prev && prev !== proper) addMsg('ai', `Noted ‚Äî updating suburb from ${prev} to ${proper}.`); } else { state.slots.suburb = null; state.suburbLocked = false; renderSlots(); addMsg('ai', 'Your current location is <strong>not within the City of Melbourne</strong>. Please provide your suburb in the chat to continue.'); } el('locHint').textContent = ""; } catch (err) { el('locHint').textContent = (err && err.message) ? err.message : "Couldn‚Äôt get your location."; } finally { el('locate').disabled = false; } }

// --- Image resizer ---
function resizeImage(file, maxDim){
  return new Promise((resolve)=>{
    const img=new Image();
    img.onload=()=>{ const scale=Math.min(maxDim/img.width, maxDim/img.height, 1); const w=Math.round(img.width*scale), h=Math.round(img.height*scale); const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h); resolve(c.toDataURL('image/jpeg', 0.72)); };
    const r=new FileReader(); r.onload=()=> img.src=r.result; r.readAsDataURL(file);
  });
}
</script>
</body>
</html>
