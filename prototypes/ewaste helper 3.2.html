<!doctype html>
<html lang="en-au">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>City of Melbourne ‚Äî E-Waste Helper (Chat + Quick Menu)</title>
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --ink:#111111; --muted:#444;
      --accent:#f5b7c8; --line:#e9e9e9; --pill:#eef2f7;
      --link:#d63b82; --blue:#eef7ff; --blueborder:#d7eaff;
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    a{color:var(--link)}
    header{display:flex;align-items:center;gap:8px;justify-content:center;position:relative;
      padding:20px 16px;background:linear-gradient(180deg,#fde8ef 0,#fff 100%);border-bottom:1px solid var(--line)}
    header h1{margin:0 0 6px;font-weight:800;letter-spacing:.2px}
    header p{margin:0;color:#333}
    .toggle-wrap{position:absolute;right:12px;top:12px}
    .toggle{appearance:none;border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
    .toggle:hover{border-color:var(--accent);box-shadow:0 0 0 2px rgba(245,183,200,.25) inset}
    main{max-width:980px;margin:0 auto;padding:12px 16px 80px}
    .grid{display:grid;gap:16px}
    @media (min-width:880px){ .grid.cols-2{grid-template-columns: 2fr 1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 18px rgba(17,17,17,.06);padding:18px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--pill);border:1px solid var(--line);font-size:.8rem;color:#555}
    .tiny{font-size:12px;color:#666}
    .hint{color:#555}

    /* Chat view */
    .chatwrap{display:flex;flex-direction:column;gap:12px}
    .messages{display:flex;flex-direction:column;gap:10px;max-height:62vh;overflow:auto;padding-right:4px}
    .msg{display:flex}
    .bubble{padding:10px 12px;border-radius:14px;max-width:85%}
    .ai .bubble{background:#fff6fa;border:1px solid var(--line)}
    .me{justify-content:flex-end}
    .me .bubble{background:#f7f8fb;border:1px solid var(--line)}
    .slots{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .slot{padding:10px;border-radius:12px;background:#fff;border:1px solid var(--line)}
    .slot strong{display:block;font-size:12px;color:#666}
    .row{display:flex;gap:8px;align-items:center}
    .row input[type="text"]{flex:1;padding:12px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#151515}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;color:#111;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{border-color:var(--accent);box-shadow:0 0 0 2px rgba(245,183,200,.25) inset}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#ffcee0);border-color:transparent;color:#111}
    label.filebtn{border:1px dashed var(--line);padding:10px 12px;border-radius:12px;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
    input[type="file"]{display:none}
    .imgthumb{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px 10px;background:#fff}
    .imgthumb img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    .site{padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;margin:6px 0}
    .site a{color:var(--link);text-decoration:none}
    .footer{color:#555;font-size:.9rem;margin-top:8px}
    .retail-badge{display:inline-block;font-size:.75rem;background:var(--blue);border:1px solid var(--blueborder);border-radius:999px;padding:2px 8px;margin-left:6px}
    .section-title{margin:10px 0 6px;font-weight:700}

    /* Quick Menu view */
    #formView .form-grid{display:grid;gap:12px}
    @media(min-width:720px){ #formView .form-grid{grid-template-columns:1fr 1fr} }
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-weight:600}
    select{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .radios{display:flex;gap:10px;flex-wrap:wrap}
    .error{color:#a3082a;font-size:.9rem}
    .results{margin-top:10px}
    [hidden]{display:none !important}

    /* Category grid */
    .cat-grid{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}
    @media(min-width:700px){ .cat-grid{grid-template-columns:repeat(3,1fr)} }
    @media(min-width:980px){ .cat-grid{grid-template-columns:repeat(4,1fr)} }
    .cat{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff;cursor:pointer}
    .cat:hover{border-color:var(--accent);box-shadow:0 0 0 2px rgba(245,183,200,.2) inset}
    .cat.active{outline:2px solid #ff9fc1}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>City of Melbourne ‚Äî E-Waste Helper</h1>
      <p>Classify items, size them, verify your CoM suburb, and find the nearest drop-off. Images supported.</p>
    </div>
    <div class="toggle-wrap">
      <button id="toggleViewBtn" class="toggle" aria-pressed="false" title="Switch to Quick Menu">Quick Menu ‚ñ∏</button>
    </div>
  </header>

  <!-- CHAT VIEW -->
  <main id="chatView" class="grid cols-2">
    <section class="card">
      <div class="chatwrap">
        <div class="messages" id="log"></div>
        <div class="slots" id="slots"></div>
        <div class="row">
          <input id="input" type="text" placeholder="Type an item (e.g., ‚Äòold phone, small, 3000‚Äô)‚Ä¶" />
          <button id="send" class="btn primary">Send</button>
          <label class="filebtn" title="Upload a photo">
            <input id="file" type="file" accept="image/*" /> üì∑ Image
          </label>
        </div>
        <div class="tiny">After results we‚Äôll reuse your suburb. Start a new item any time (e.g., ‚Äúgraphics card‚Äù).</div>
      </div>
    </section>

    <aside class="card">
      <div><strong>Status</strong> <span id="status" class="pill">Ready</span></div>
      <button id="locate" class="btn" style="margin-top:8px">Use my location</button>
      <div id="locHint" class="tiny"></div>
      <hr />
      <div><strong>Safety quick guide</strong></div>
      <ul class="safety-list">
        <li><strong>Never put e-waste in household or recycling bins.</strong> Use drop-off points only.</li>
        <li><strong>Batteries & vapes:</strong> tape terminals, place in a clear bag. If damaged, swollen or hot, isolate and contact the site first.</li>
        <li><strong>Phones & computers:</strong> back up and <em>factory-reset</em>; remove SIM/SD cards.</li>
        <li><strong>Pack safely:</strong> keep devices dry; avoid crushing; don‚Äôt mix loose batteries with metal objects.</li>
        <li>More info: <a href="https://www.melbourne.vic.gov.au/a-z-waste-guide" target="_blank" rel="noopener">A‚ÄìZ Waste Guide</a> ¬∑ 
        <a href="https://www.melbourne.vic.gov.au/e-waste-and-chemicals" target="_blank" rel="noopener">E-Waste &amp; Chemicals</a></li>
      </ul>

      <!-- NEW: Not accepted list -->
      <hr />
      <div><strong>Not accepted at these drop-offs</strong></div>
      <div class="tiny" style="margin:4px 0 6px">
        These items are <em>not</em> accepted at collection/retail e-waste points or require special handling. See the A‚ÄìZ Waste Guide for alternatives.
      </div>
      <ul class="safety-list">
        <li>Chemicals</li>
        <li>Smoke alarms</li>
        <li>Air conditioners</li>
        <li>Halogen lights</li>
        <li>X-ray equipment</li>
        <li>Hazardous material and medical equipment</li>
        <li>Car, truck and eBike batteries</li>
        <li>White goods</li>
        <li>Compact fluorescent tubes</li>
        <li>Fluorescent tubes</li>
        <li>Paint</li>
      </ul>
    </aside>
  </main>

  <!-- QUICK MENU VIEW -->
  <main id="formView" class="grid" hidden>
    <section class="card">
      <h2 style="margin-top:0">Quick Menu</h2>

      <!-- Category grid -->
      <div class="field">
        <label>Category</label>
        <div id="catGrid" class="cat-grid"></div>
        <input type="hidden" id="qCategory" />
        <div id="errCat" class="error" hidden>Please choose a category.</div>
      </div>

      <div class="form-grid" style="margin-top:8px">
        <div class="field">
          <label>Size</label>
          <div class="radios">
            <label><input type="radio" name="qSize" value="small"> Small</label>
            <label><input type="radio" name="qSize" value="medium"> Medium</label>
            <label><input type="radio" name="qSize" value="large"> Large</label>
          </div>
          <div id="errSize" class="error" hidden>Please choose a size.</div>
        </div>

        <div class="field">
          <label for="qSuburbSel">Suburb (City of Melbourne)</label>
          <select id="qSuburbSel"></select>
          <div id="errSuburb" class="error" hidden>Please select a suburb.</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px">
        <button id="qSubmit" class="btn primary">Show results</button>
        <button id="qReset" class="btn">Reset</button>
      </div>

      <div id="qResults" class="results"></div>
    </section>
  </main>

<script>
/* ------------------------------
   Shared data & helpers
---------------------------------- */
const WORKER_URL = "https://ewasteworker.haydenvltang.workers.dev";

const COM_SUBURBS = ['Melbourne','Docklands','Southbank','West Melbourne','North Melbourne','Carlton','East Melbourne','Parkville','Kensington','South Yarra'];
const COM_POSTCODE_MAP = {
  '3000':'Melbourne','3002':'East Melbourne','3003':'West Melbourne','3004':'Melbourne',
  '3006':'Southbank','3008':'Docklands','3031':'Kensington','3051':'North Melbourne',
  '3052':'Parkville','3053':'Carlton','3141':'South Yarra'
};
function postcodeToComSuburb(pc){ const s = COM_POSTCODE_MAP[pc]; return s && COM_SUBURBS.includes(s) ? s : null; }

const CATS = {
  phones_tablets:{label:'Mobile Phones & Tablets',def:'small',hazards:['data','battery']},
  laptops:{label:'Laptops & Notebooks',def:'small',hazards:['data','battery']},
  desktops_pc:{label:'Desktops & PC Components',def:'medium',hazards:['data']},
  monitors:{label:'Monitors & Computer Displays',def:'medium'},
  tvs:{label:'TVs & Large Screens',def:'large',hazards:['bulky']},
  consoles:{label:'Gaming Consoles & Accessories',def:'small'},
  cameras_drones:{label:'Cameras, Drones & Imaging',def:'small',hazards:['battery','data']},
  audio_hifi:{label:'Audio & Hi-Fi',def:'small'},
  networking_smart:{label:'Networking & Smart-Home',def:'small'},
  printers_office:{label:'Printers, Scanners & Office',def:'medium'},
  storage_media:{label:'Data Storage & Media',def:'small',hazards:['data']},
  cables_chargers:{label:'Cables, Chargers & Adapters',def:'small'},
  batteries:{label:'Batteries (All)',def:'small',hazards:['battery']},
  vapes:{label:'Vapes & E-Cigs',def:'small',hazards:['battery']},
  wearables_personal:{label:'Wearables & Personal Care',def:'small'},
  small_kitchen:{label:'Small Kitchen Appliances',def:'medium'},
  floor_air_care:{label:'Floor & Air Care',def:'medium'},
  power_tools_garden:{label:'Power Tools & Garden',def:'small',hazards:['battery']},
  lamps_lighting:{label:'Lamps & Lighting',def:'small',hazards:['mercury']},
  microwaves_bench:{label:'Microwaves & Bench Ovens',def:'large',hazards:['bulky']},
  whitegoods_large:{label:'Large Appliances (Whitegoods)',def:'large',hazards:['bulky']}
};
const CAT_IDS = Object.keys(CATS);
const labelFor = id => (CATS[id]?.label ?? id);

const LOCATIONS = [
  { name:'Melbourne Library (CBD)', address:'253 Flinders Ln, Melbourne VIC 3000',
    types:['phones_tablets','laptops','consoles','cameras_drones','audio_hifi','networking_smart','storage_media','cables_chargers','batteries','vapes','wearables_personal','small_kitchen','power_tools_garden','lamps_lighting'],
    suburb:'Melbourne', lat:-37.8165, lng:144.9652 },
  { name:'Library at The Dock', address:'107 Victoria Harbour Promenade, Docklands VIC 3008',
    types:['phones_tablets','laptops','consoles','cameras_drones','audio_hifi','networking_smart','storage_media','cables_chargers','batteries','vapes','wearables_personal','small_kitchen','power_tools_garden','lamps_lighting'],
    suburb:'Docklands', lat:-37.8215, lng:144.9436 },
  { name:'Boyd Community Hub', address:'207 City Rd, Southbank VIC 3006',
    types:['phones_tablets','laptops','consoles','cameras_drones','audio_hifi','networking_smart','storage_media','cables_chargers','batteries','vapes','wearables_personal','small_kitchen','power_tools_garden','lamps_lighting'], suburb:'Southbank', lat:-37.8248, lng:144.9628 },
  { name:'East Melbourne Library', address:'22 George St, East Melbourne VIC 3002',
    types:['phones_tablets','laptops','consoles','cameras_drones','audio_hifi','networking_smart','storage_media','cables_chargers','batteries','vapes','wearables_personal','small_kitchen','power_tools_garden','lamps_lighting'], suburb:'East Melbourne', lat:-37.8136, lng:144.9869 },
  { name:'North Melbourne Library', address:'66 Errol St, North Melbourne VIC 3051',
    types:['phones_tablets','laptops','consoles','cameras_drones','audio_hifi','networking_smart','storage_media','cables_chargers','batteries','vapes','wearables_personal','small_kitchen','power_tools_garden','lamps_lighting'], suburb:'North Melbourne', lat:-37.8037, lng:144.9499 },
  { name:'Kensington Town Hall', address:'30‚Äì34 Bellair St, Kensington VIC 3031',
    types:['phones_tablets','laptops','consoles','cameras_drones','audio_hifi','networking_smart','storage_media','cables_chargers','batteries','vapes','wearables_personal','small_kitchen','power_tools_garden','lamps_lighting'], suburb:'Kensington', lat:-37.7937, lng:144.9318 },
  { name:'Kathleen Syme Library & Community Centre', address:'251 Faraday St, Carlton VIC 3053',
    types:['phones_tablets','laptops','consoles','cameras_drones','audio_hifi','networking_smart','storage_media','cables_chargers','batteries','vapes','wearables_personal','small_kitchen','power_tools_garden','lamps_lighting'], suburb:'Carlton', lat:-37.8005, lng:144.9708 },
  { name:'Dynon Rd Transfer Station (staffed)', address:'437 Dynon Rd, West Melbourne VIC 3003',
    types:[ ...CAT_IDS ], suburb:'West Melbourne', lat:-37.8064, lng:144.9148 },
];

const RETAIL_SITES = [
  { id:'retail-ow-west-melb', brand:'Officeworks', name:'Officeworks West Melbourne', address:'443-459 Victoria St, West Melbourne VIC 3003', lat:-37.8069, lng:144.9380, suburb:'West Melbourne', accepts:['household-batteries'] },
  { id:'retail-coles-cbd', brand:'Coles', name:'Coles Melbourne CBD', address:'260 Elizabeth St, Melbourne VIC 3000', lat:-37.8119, lng:144.9630, suburb:'Melbourne', accepts:['household-batteries'] },
  { id:'retail-woolworths-qv', brand:'Woolworths', name:'Woolworths QV', address:'Cnr Lonsdale & Swanston St, Melbourne VIC 3000', lat:-37.8099, lng:144.9645, suburb:'Melbourne', accepts:['household-batteries'] },
  { id:'retail-aldi-docklands', brand:'ALDI', name:'ALDI Docklands', address:'737 Bourke St, Docklands VIC 3008', lat:-37.8190, lng:144.9465, suburb:'Docklands', accepts:['household-batteries'] },
  { id:'retail-jbhifi-elizabeth', brand:'JB Hi-Fi', name:'JB Hi-Fi Elizabeth St', address:'365-371 Elizabeth St, Melbourne VIC 3000', lat:-37.8088, lng:144.9606, suburb:'Melbourne', accepts:['household-batteries'] },
  { id:'retail-ow-elizabeth', brand:'Officeworks', name:'Officeworks Melbourne ‚Äî Elizabeth St', address:'107 Elizabeth St, Melbourne VIC 3000', lat:-37.8169, lng:144.9637, suburb:'Melbourne', accepts:['household-batteries'] },
  { id:'retail-ow-bourke', brand:'Officeworks', name:'Officeworks Melbourne ‚Äî Bourke St', address:'Shops 1‚Äì2, 461 Bourke St, Melbourne VIC 3000', lat:-37.8145, lng:144.9609, suburb:'Melbourne', accepts:['household-batteries'] },
  { id:'retail-coles-elizabeth-flinders', brand:'Coles', name:'Coles Central ‚Äî Elizabeth & Flinders', address:'Cnr Elizabeth & Flinders St, Melbourne VIC 3000', lat:-37.8183, lng:144.9640, suburb:'Melbourne', accepts:['household-batteries'] },
  { id:'retail-coles-spencer', brand:'Coles', name:'Coles Spencer St (Outlet Centre)', address:'201 Spencer St, Melbourne VIC 3000', lat:-37.8156, lng:144.9553, suburb:'Melbourne', accepts:['household-batteries'] },
  { id:'retail-coles-melbourne-central', brand:'Coles', name:'Coles ‚Äî Melbourne Central', address:'211 La Trobe St, Melbourne VIC 3000', lat:-37.8095, lng:144.9631, suburb:'Melbourne', accepts:['household-batteries'] },
  { id:'retail-woolworths-vic-harbour', brand:'Woolworths', name:'Woolworths ‚Äî Victoria Harbour', address:'63‚Äì93 Merchant St, Docklands VIC 3008', lat:-37.8211, lng:144.9439, suburb:'Docklands', accepts:['household-batteries'] },
  { id:'retail-woolworths-southbank', brand:'Woolworths Metro', name:'Woolworths Metro ‚Äî Southbank', address:'245‚Äì263 City Rd, Southbank VIC 3006', lat:-37.8241, lng:144.9642, suburb:'Southbank', accepts:['household-batteries'] },
  { id:'retail-aldi-cbd', brand:'ALDI', name:'ALDI ‚Äî Melbourne CBD (Swanston/Franklin)', address:'501 Swanston St, Melbourne VIC 3000', lat:-37.8079, lng:144.9638, suburb:'Melbourne', accepts:['household-batteries'] },
  { id:'retail-aldi-west-melbourne', brand:'ALDI', name:'ALDI ‚Äî West Melbourne', address:'528 Spencer St, West Melbourne VIC 3003', lat:-37.8087, lng:144.9495, suburb:'West Melbourne', accepts:['household-batteries'] },
  { id:'retail-jbhifi-melbourne-central', brand:'JB Hi-Fi', name:'JB Hi-Fi ‚Äî Melbourne Central', address:'L01, Shop 101B, 211 La Trobe St, Melbourne VIC 3000', lat:-37.8093, lng:144.9632, suburb:'Melbourne', accepts:['household-batteries'] }
];

const VIC_POSTCODE_RE = /\b3\d{3}\b/;
function toTitle(s){ if(!s) return ''; return s.replace(/\b\w+/g, t=> t==='tv' ? 'TV' : t.charAt(0).toUpperCase()+t.slice(1)); }
function capWord(s){ return !s ? '' : s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(); }
function gmapsLink(lat,lng,name){ const q=encodeURIComponent(`${name} @ ${lat},${lng}`); return `https://www.google.com/maps/search/?api=1&query=${q}`; }
function linksFooter(){ return `<div class="footer"><a href="https://cityofmelbourne-hardwaste.cleanaway.com.au/" target="_blank" rel="noopener"><strong>Free hard-waste booking</strong></a></div>`; }
function haversine(aLat,aLng,bLat,bLng){ const R=6371; const toRad=x=>x*Math.PI/180; const dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng); const s1=Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(s1)); }
function locationAccepts(categoryId, loc){ return (loc.types?.includes(categoryId)) || (loc.types?.includes('*')); }
function nearbyCouncilSites(categoryId, suburb){
  const accepts = LOCATIONS.filter(x => locationAccepts(categoryId, x));
  const sorted = accepts.sort((a,b)=>{
    const aScore=(a.suburb===suburb?0:1)+(a.name.includes('Transfer Station')?0.3:0.6);
    const bScore=(b.suburb===suburb?0:1)+(b.name.includes('Transfer Station')?0:0.3);
    return aScore - bScore;
  });
  return sorted.slice(0,4);
}
function isBatteryish(catId){ return ['batteries','vapes','power_tools_garden'].includes(catId); }
function nearbyRetailSites(refLat, refLng, max=5){
  const arr = (RETAIL_SITES || []).filter(s => (s.accepts||[]).includes('household-batteries'));
  const withD = arr.map(s => ({...s, _d: haversine(refLat,refLng,s.lat,s.lng)})).sort((a,b)=>a._d-b._d);
  return withD.slice(0, max);
}
function safetyBlurb(catId, size){
  const hazards = new Set(CATS[catId]?.hazards || []);
  const lines = [];
  if(hazards.has('battery')) lines.push('Batteries/vapes: tape terminals, bag separately; never place in household or recycling bins.');
  if(hazards.has('data'))    lines.push('Back up and factory-reset where applicable; remove SIM/SD cards and wipe drives.');
  if(hazards.has('mercury')) lines.push('CFL/fluoro lamps may contain mercury ‚Äî keep intact and deliver carefully.');
  if(hazards.has('bulky') || size==='large') lines.push('Bulky item ‚Äî prefer the staffed transfer station or book a free hard-waste collection.');
  return lines.join(' ');
}

/* ------------------------------
   CHATBOT
---------------------------------- */
const state = { slots:{item:null,size:null,suburb:null}, suburbLocked:false, history:[], presentedKey:null, flags:{justListedEligible:false, mappedPostcode:null} };
const el = id=>document.getElementById(id);
const logEl = el('log'); const slotsEl = el('slots'); const statusEl = el('status');
const inputEl = el('input'); const fileEl = el('file');

function addMsg(who, html){ const wrap=document.createElement('div'); wrap.className='msg '+who; const bubble=document.createElement('div'); bubble.className='bubble'; bubble.innerHTML=html; wrap.appendChild(bubble); logEl.appendChild(wrap); logEl.scrollTop=logEl.scrollHeight; }
function fmtSlot(key,val){ if(!val) return '(missing)'; if(key==='item') return '<span class="strong">'+labelFor(val)+'</span>'; if(key==='suburb') return '<span class="strong">'+toTitle(val)+'</span>'; if(key==='size') return '<span class="strong">'+capWord(val)+'</span>'; return val; }
function renderSlots(){ const s=state.slots; slotsEl.innerHTML=''; [['Item (category)','item'],['Size','size'],['Suburb','suburb']].forEach(([label,key])=>{const d=document.createElement('div'); d.className='slot'; d.innerHTML=`<strong>${label}</strong><div class="value">${fmtSlot(key,s[key])}</div>`; slotsEl.appendChild(d);}); }
function prettyCategory(catId){ return '<span class="strong">'+labelFor(catId)+'</span>'; }
function prettyItemSizeSuburb(){ const s=state.slots; const sizeTxt=s.size?'<span class="strong">'+capWord(s.size)+'</span>':''; const suburbTxt=s.suburb?'<span class="strong">'+toTitle(s.suburb)+'</span>':''; return `${prettyCategory(s.item)}${sizeTxt?' ('+sizeTxt+')':''} ‚Äî ${suburbTxt}`; }

function presentResults(){
  const s=state.slots;
  const council = nearbyCouncilSites(s.item, s.suburb);
  const councilList = council.map(x => `
    <div class="site">
      <div><strong>${x.name}</strong></div>
      <div>${x.address}</div>
      <div><a href="${gmapsLink(x.lat,x.lng,x.name)}" target="_blank" rel="noopener"><strong>Open in Google Maps</strong></a></div>
    </div>`).join('');
  let retailBlock = '';
  if (isBatteryish(s.item)) {
    const ref = { lat: council[0]?.lat ?? -37.8165, lng: council[0]?.lng ?? 144.9652 };
    const retail = nearbyRetailSites(ref.lat, ref.lng, 5);
    if (retail.length) {
      const retailList = retail.map(r => `
        <div class="site">
          <div><strong>${r.brand} ‚Äî ${r.name || r.suburb}</strong><span class="retail-badge">Retail battery drop-off</span></div>
          <div>${r.address}</div>
          <div><a href="${gmapsLink(r.lat,r.lng,r.name||r.brand)}" target="_blank" rel="noopener"><strong>Open in Google Maps</strong></a></div>
        </div>`).join('');
      retailBlock = `<div class="section-title">Retail battery drop-off near ${toTitle(s.suburb)}</div>${retailList}`;
    }
  }
  addMsg('ai', `<div>
    <div><strong>Closest drop-off options for ${prettyItemSizeSuburb()}</strong></div>
    ${councilList || '<div>No matching City of Melbourne sites in dataset.</div>'}
    ${retailBlock}
    <div class="hint" style="margin-top:8px">${safetyBlurb(s.item,s.size)}</div>
    ${linksFooter()}
  </div>
  <div style="margin-top:6px">Another item? You can type it or upload a photo ‚Äî I‚Äôll reuse your suburb.</div>`);
  state.presentedKey = s.item + "|" + s.size + "|" + s.suburb;
  try{ if(s.suburb) localStorage.setItem('ewh_last_suburb', s.suburb); }catch(_){}
}
function maybePresentOnce(){ const s=state.slots; if(s.item && s.size && s.suburb){ const key=s.item+"|"+s.size+"|"+s.suburb; if(key!==state.presentedKey){ presentResults(); } } }

/* alias tables + classification */
function re(words){ return new RegExp(`(^|[^a-z0-9])(${words.join('|').replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&')})([^a-z0-9]|$)`,'i'); }
const ALIAS_TABLE=[ /* ‚Ä¶ same as previous message ‚Ä¶ */ 
  { re: re(['phone','iphone','android','smartphone','mobile','cell phone','handset','blackberry','pixel']), cat:'phones_tablets' },
  { re: re(['tablet','ipad','galaxy tab','surface go','surface pro']), cat:'phones_tablets' },
  { re: re(['laptop','notebook','macbook','chromebook']), cat:'laptops' },
  { re: re(['desktop','pc tower','gaming pc','workstation','sff pc']), cat:'desktops_pc', size:'medium' },
  { re: re(['gpu','graphics card','video card','rtx','gtx','radeon','rx']), cat:'desktops_pc', size:'small' },
  { re: re(['cpu','processor','i3','i5','i7','ryzen']), cat:'desktops_pc', size:'small' },
  { re: re(['motherboard','mainboard']), cat:'desktops_pc', size:'small' },
  { re: re(['ram','memory ddr','ddr3','ddr4','ddr5']), cat:'desktops_pc', size:'small' },
  { re: re(['psu','power supply','atx psu','sfx psu']), cat:'desktops_pc', size:'small' },
  { re: re(['monitor','pc display','lcd monitor','led monitor']), cat:'monitors', size:'medium' },
  { re: re(['tv','television','smart tv','oled tv','lcd tv','plasma tv','led tv','flat screen']), cat:'tvs', size:'large' },
  { re: re(['ps5','playstation','ps4','xbox','series x','series s','nintendo switch','wii u','wii','game console','console']), cat:'consoles' },
  { re: re(['controller','joy-con','dualsense','gamepad','xbox controller','vr headset','quest','psvr']), cat:'consoles', size:'small' },
  { re: re(['camera','dslr','mirrorless','action cam','gopro','camcorder','webcam','lens','drone','mavic','phantom']), cat:'cameras_drones' },
  { re: re(['headphones','earbuds','airpods','headset','earphones','speaker','soundbar','subwoofer','amplifier','receiver','home theatre','smart speaker','echo','homepod','google home']), cat:'audio_hifi' },
  { re: re(['router','modem','mesh','wifi','access point','ethernet switch','nvr','smart hub','zigbee','z-wave','bridge','chromecast','apple tv']), cat:'networking_smart' },
  { re: re(['printer','scanner','mfp','photocopier','fax','label printer']), cat:'printers_office', size:'medium' },
  { re: re(['hdd','ssd','hard drive','solid state','nvme','sata ssd','usb stick','flash drive','thumb drive','sd card','micro sd','cf card','cd','dvd','blu-ray','bluray','disk','disc']), cat:'storage_media' },
  { re: re(['cable','lead','cord','charger','power brick','power adapter','usb','usb-c','usbc','lightning cable','apple cable','hdmi','displayport','dp','vga','dvi','aux','rca','ethernet','cat5','cat6']), cat:'cables_chargers' },
  { re: re(['battery','aa','aaa','9v','button cell','coin cell','lithium','li-ion','li ion','nimh','sla','sealed lead acid','ups battery','tool battery','drill battery','power bank']), cat:'batteries' },
  { re: re(['vape','vape device','disposable vape','e-cig','ecig','pod vape','elfbar']), cat:'vapes' },
  { re: re(['smartwatch','fitness band','fitbit','garmin watch','polar watch','electric toothbrush','shaver','trimmer','hair dryer','hair straightener']), cat:'wearables_personal' },
  { re: re(['kettle','toaster','air fryer','rice cooker','slow cooker','benchtop oven','coffee machine','espresso','blender','mixer','food processor','bread maker','juicer']), cat:'small_kitchen' },
  { re: re(['vacuum','stick vac','robot vacuum','dyson','fan','heater','oil heater','panel heater','air purifier','humidifier','dehumidifier']), cat:'floor_air_care' },
  { re: re(['drill','saw','sander','whipper snipper','line trimmer','hedge trimmer','leaf blower','pressure washer','charger']), cat:'power_tools_garden' },
  { re: re(['lamp','desk lamp','downlight','light fitting','led bulb','cfl','fluoro','fluorescent','transformer','driver']), cat:'lamps_lighting' },
  { re: re(['microwave','microwave oven','convection microwave','benchtop oven']), cat:'microwaves_bench', size:'large' },
  { re: re(['refrigerator','refridgerator','refridgeratr','fridge','bar fridge','fridge freezer','freezer']), cat:'whitegoods_large', size:'large' },
  { re: re(['washing machine','washer','dryer','dishwasher','oven','rangehood','cooktop']), cat:'whitegoods_large', size:'large' },
];
function classifyFromAliases(text){ const t=(text||''); for(const row of ALIAS_TABLE){ if(row.re.test(t)) return { item: row.cat, size: row.size || CATS[row.cat].def }; } return null; }
function fallbackCategoryAndSize(text){ const t=(text||'').toLowerCase();
  if (/(phone|iphone|android|tablet|ipad|galaxy tab|surface)/.test(t)) return { item:'phones_tablets', size:CATS.phones_tablets.def };
  if (/(laptop|notebook|macbook|chromebook)/.test(t)) return { item:'laptops', size:CATS.laptops.def };
  if (/(desktop|tower|workstation|gpu|graphics|video card|cpu|motherboard|ram|psu)/.test(t)) return { item:'desktops_pc', size:CATS.desktops_pc.def };
  if (/(monitor|pc display)/.test(t)) return { item:'monitors', size:CATS.monitors.def };
  if (/\btv\b|television|oled tv|lcd tv|plasma/.test(t)) return { item:'tvs', size:CATS.tvs.def };
  if (/(console|ps5|playstation|xbox|nintendo|controller|gamepad|joy-con|vr)/.test(t)) return { item:'consoles', size:CATS.consoles.def };
  if (/(camera|dslr|mirrorless|gopro|camcorder|webcam|lens|drone|mavic)/.test(t)) return { item:'cameras_drones', size:CATS.cameras_drones.def };
  if (/(headphone|earbud|earphone|speaker|soundbar|subwoofer|amplifier|receiver|home theatre|smart speaker|echo|homepod)/.test(t)) return { item:'audio_hifi', size:CATS.audio_hifi.def };
  if (/(router|modem|mesh|wifi|access point|ethernet switch|nvr|smart hub|zigbee|z-wave|bridge|chromecast|apple tv)/.test(t)) return { item:'networking_smart', size:CATS.networking_smart.def };
  if (/(printer|scanner|mfp|photocopier|fax|label printer)/.test(t)) return { item:'printers_office', size:CATS.printers_office.def };
  if (/(hdd|ssd|hard drive|nvme|usb stick|flash drive|thumb drive|sd card|dvd|cd|blu-?ray)/.test(t)) return { item:'storage_media', size:CATS.storage_media.def };
  if (/(cable|lead|cord|charger|adapter|power brick|usb|hdmi|displayport|dp|vga|dvi|aux|rca|ethernet|cat5|cat6|lightning)/.test(t)) return { item:'cables_chargers', size:CATS.cables_chargers.def };
  if (/(battery|aa|aaa|9v|button cell|coin cell|lithium|nimh|sla|ups|tool battery|power bank)/.test(t)) return { item:'batteries', size:CATS.batteries.def };
  if (/(vape|vape device|e-?cig|disposable vape|pod vape|elfbar)/.test(t)) return { item:'vapes', size:CATS.vapes.def };
  if (/(smartwatch|fitness band|fitbit|garmin|electric toothbrush|shaver|trimmer|hair dryer|straightener)/.test(t)) return { item:'wearables_personal', size:CATS.wearables_personal.def };
  if (/(kettle|toaster|air fryer|rice cooker|slow cooker|coffee machine|espresso|blender|mixer|food processor|bread maker|juicer)/.test(t)) return { item:'small_kitchen', size:CATS.small_kitchen.def };
  if (/(vacuum|stick vac|robot vacuum|fan|heater|air purifier|humidifier|dehumidifier)/.test(t)) return { item:'floor_air_care', size:CATS.floor_air_care.def };
  if (/(drill|saw|sander|trimmer|blower|pressure washer|charger)/.test(t)) return { item:'power_tools_garden', size:CATS.power_tools_garden.def };
  if (/(lamp|downlight|light fitting|led bulb|cfl|fluoro|fluorescent|transformer|driver)/.test(t)) return { item:'lamps_lighting', size:CATS.lamps_lighting.def };
  if (/(microwave|benchtop oven|convection microwave)/.test(t)) return { item:'microwaves_bench', size:CATS.microwaves_bench.def };
  if (/(fridge|refrigerator|refridgerator|freezer|washing machine|washer|dryer|dishwasher|oven|rangehood|cooktop)/.test(t)) return { item:'whitegoods_large', size:CATS.whitegoods_large.def };
  return { item:'cables_chargers', size:CATS.cables_chargers.def };
}

function mapLegacyCategory(oldCat, hintText){
  const t=(hintText||'').toLowerCase();
  switch((oldCat||'').toLowerCase()){
    case 'batteries': return 'batteries';
    case 'phones': return 'phones_tablets';
    case 'cables': return 'cables_chargers';
    case 'tv': return 'tvs';
    case 'printer': return 'printers_office';
    case 'microwave': return 'microwaves_bench';
    case 'computers':
      if(/monitor|display/.test(t)) return 'monitors';
      if(/laptop|notebook|macbook|chromebook/.test(t)) return 'laptops';
      if(/console|xbox|playstation|nintendo|controller|gamepad|vr/.test(t)) return 'consoles';
      if(/router|modem|mesh|switch|nvr|chromecast|apple tv|hub/.test(t)) return 'networking_smart';
      if(/camera|webcam|gopro|drone|lens/.test(t)) return 'cameras_drones';
      if(/headphone|earbud|speaker|soundbar|receiver|amplifier|home ?theatre|smart speaker|echo|homepod/.test(t)) return 'audio_hifi';
      return 'desktops_pc';
    case 'appliance':
      if(/fridge|refrigerator|refridgerator|freezer|washer|washing|dryer|dishwasher|oven|rangehood|cooktop/.test(t)) return 'whitegoods_large';
      if(/microwave|benchtop oven/.test(t)) return 'microwaves_bench';
      if(/vacuum|fan|heater|purifier|humidifier|dehumidifier|air/.test(t)) return 'floor_air_care';
      if(/kettle|toaster|coffee|espresso|air fryer|blender|mixer|food processor|rice cooker|slow cooker|bread maker|juicer/.test(t)) return 'small_kitchen';
      return 'small_kitchen';
    default: return null;
  }
}

/* image guard, worker, VIC handlers */
const NON_EWASTE_TERMS=['person','people','man','woman','boy','girl','face','selfie','portrait','baby','dog','cat','animal','bird','fish','horse','food','dish','meal','plate','pizza','burger','cake','drink','bottle','cup','plant','flower','tree','leaf','shoe','shirt','bag','chair','table','sofa','bed','car','bicycle','book','paper','pen','toothbrush','toilet','sink'];
const EWASTE_WHITELIST_HINTS=['phone','laptop','computer','pc','monitor','screen','tv','television','console','xbox','playstation','nintendo','router','modem','switch','printer','scanner','microwave','camera','gopro','drone','headphone','earbud','airpod','smartwatch','fitbit','ssd','hdd','gpu','graphics','motherboard','cpu','ram','charger','cable','usb','hdmi','battery','power bank','vape'];
function isLikelyEwaste(label){ const t=(label||'').toLowerCase().trim(); if(!t) return false; if(classifyFromAliases(t)) return true; if(EWASTE_WHITELIST_HINTS.some(h=>t.includes(h))) return true; return false; }
function isNonEwasteLabel(label){ return !isLikelyEwaste(label); }
async function callWorker(userText, imageDataUrl){
  statusEl.textContent='Thinking‚Ä¶';
  const payload={ history: state.history.slice(-6), user_text: userText || '', image: imageDataUrl || null, known_slots: state.slots, suburbs: COM_SUBURBS };
  try{ const res = await fetch(WORKER_URL + '/classify', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); if(!res.ok) throw new Error(await res.text()); return await res.json(); }
  catch(err){ addMsg('ai', `<span class="hint">Proxy error: ${(err && err.message) || err}</span>`); return null; }
  finally{ statusEl.textContent='Ready'; }
}
async function geocodeVic(query){ const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&addressdetails=1&countrycodes=au&state=Victoria&q=${encodeURIComponent(query + ', Victoria, Australia')}`; const res = await fetch(url, { headers: { 'Accept': 'application/json' } }); if(!res.ok) return null; const arr = await res.json(); if(!Array.isArray(arr) || !arr.length) return null; const r = arr[0]; const a = r.address || {}; const isVic = /victoria/i.test(a.state||'') || /vic/i.test(a.state||''); return { lat: parseFloat(r.lat), lng: parseFloat(r.lon), display: r.display_name, suburb: a.suburb || a.town || a.city || a.village || '', postcode: a.postcode || '', isVic }; }
function nearestComSite(lat,lng){ let best=null; let dBest=Infinity; for(const s of LOCATIONS){ const d=haversine(lat,lng,s.lat,s.lng); if(d<dBest){ dBest=d; best=s; } } return { site: best, km: dBest }; }
async function handleVicOutsideCOM(raw){
  const t=(raw||'').trim(); if(!t) return false;
  const pc=(t.match(VIC_POSTCODE_RE)||[])[0];
  if(pc){ const com=postcodeToComSuburb(pc); if(com){ if(state.flags.mappedPostcode!==pc){ const prev=state.slots.suburb; state.slots.suburb=com; state.suburbLocked=true; renderSlots(); addMsg('ai', `Postcode <strong>${pc}</strong> maps to <strong>${com}</strong> (City of Melbourne).`); if(prev && prev!==com) addMsg('ai', `Noted ‚Äî updating suburb from ${prev} to ${com}.`); state.flags.mappedPostcode=pc; } return true; }
    try{ const info=await geocodeVic(pc); if(info && info.isVic){ const near=nearestComSite(info.lat,info.lng); if(near.site){ addMsg('ai', `I‚Äôve noted <span class="strong">VIC ${pc}</span>, which is <span class="strong">outside the City of Melbourne</span>. The closest CoM drop-off is <span class="strong">${near.site.name}</span> (${near.km.toFixed(1)} km).`); addMsg('ai', `Please choose a City of Melbourne suburb to continue: <span class="strong">${COM_SUBURBS.join(', ')}</span>.`); state.flags.justListedEligible=true; } return true; } }catch(e){} return false; }
  try{ const info=await geocodeVic(t); if(!info || !info.isVic) return false;
    if(info.suburb && COM_SUBURBS.some(s=>s.toLowerCase()===info.suburb.toLowerCase())){ const proper=COM_SUBURBS.find(s=>s.toLowerCase()===info.suburb.toLowerCase()); state.slots.suburb=proper; state.suburbLocked=true; renderSlots(); addMsg('ai', `Suburb detected: <strong>${proper}</strong> (City of Melbourne).`); return true; }
    const near=nearestComSite(info.lat,info.lng);
    if(near.site){ addMsg('ai', `I‚Äôve noted <span class="strong">${toTitle(info.suburb||info.display)}</span>, which is <span class="strong">outside the City of Melbourne</span>. The closest CoM drop-off is <span class="strong">${near.site.name}</span> (${near.km.toFixed(1)} km).`); addMsg('ai', `Please choose a City of Melbourne suburb to continue: <span class="strong">${COM_SUBURBS.join(', ')}</span>.`); state.flags.justListedEligible=true; }
    return true;
  }catch(e){ return false; }
}
function consumeUserText(text){
  const parts=(text||'').split(',').map(s=>s.trim()).filter(Boolean);
  const sizeMap={small:'small',medium:'medium',large:'large'};
  for(const p of parts){
    if(sizeMap[p.toLowerCase()]){ state.slots.size=sizeMap[p.toLowerCase()]; continue; }
    const m=p.match(VIC_POSTCODE_RE);
    if(m){ const pc=m[0]; const comSub=postcodeToComSuburb(pc); if(comSub){ state.slots.suburb=comSub; state.suburbLocked=true; state.flags.mappedPostcode=pc; } continue; }
    if(COM_SUBURBS.some(x=>x.toLowerCase()===p.toLowerCase())){ state.slots.suburb=toTitle(p); state.suburbLocked=true; continue; }
  }
  const local=classifyFromAliases(text);
  if(local){ if(!state.slots.item) state.slots.item=local.item; if(!state.slots.size) state.slots.size=local.size; }
  if(!state.slots.item){ const fb=fallbackCategoryAndSize(text); state.slots.item=fb.item; if(!state.slots.size) state.slots.size=fb.size; }
  if(state.slots.item && !state.slots.size){ state.slots.size=state.slots.size || CATS[state.slots.item].def || 'small'; }
}
function mergeModel(model,isImage){
  if(!model){ if(isImage) addMsg('ai','I couldn‚Äôt identify the photo reliably. Please type the item name (e.g., ‚ÄúTV‚Äù).'); return; }
  const vLabel = model.vision_label || model.image_label || model.label;
  if (vLabel){
    if (isLikelyEwaste(vLabel)){
      addMsg('ai', `I think this is <strong>${toTitle(vLabel)}</strong> ‚Äî if that‚Äôs wrong, tell me the correct item.`);
      const local = classifyFromAliases(vLabel) || fallbackCategoryAndSize(vLabel);
      if (isImage || !state.slots.item) state.slots.item = local?.item || state.slots.item;
      if (!state.slots.size || isImage) state.slots.size = local?.size || (state.slots.item ? CATS[state.slots.item]?.def : null) || 'small';
    } else {
      addMsg('ai', `That looks like <strong>${toTitle(vLabel)}</strong>, which isn‚Äôt an e-waste item. Please upload the electronic item itself or type its name (e.g., ‚ÄúTV‚Äù, ‚Äúlaptop‚Äù).`);
      renderSlots();
      return;
    }
  }
  const mappedLegacy=mapLegacyCategory(model.item, vLabel || '');
  if(mappedLegacy && (isImage || !state.slots.item)) state.slots.item=mappedLegacy;
  if(model.size && (isImage || !state.slots.size)) state.slots.size=model.size;
  if(!state.slots.size && state.slots.item) state.slots.size=CATS[state.slots.item]?.def || 'small';
  if(model.suburb){ state.slots.suburb=toTitle(model.suburb); if(model.suburb_ok) state.suburbLocked=true; }
  renderSlots(); maybePresentOnce();
}
addMsg('ai','Hello. Upload a photo or type your item, size (Small/Medium/Large), and a City of Melbourne suburb or postcode (e.g., 3000).');
renderSlots();
document.getElementById('send').addEventListener('click',()=>handleSubmit(inputEl.value,null).then(()=>{ inputEl.value=''; }));
inputEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter') document.getElementById('send').click(); });
document.getElementById('file').addEventListener('change', async (e)=>{ const file=e.target.files[0]; if(!file) return; const url=await resizeImage(file,1024); await handleSubmit('',url); e.target.value=''; });
document.getElementById('locate').addEventListener('click', async ()=>{
  await useMyLocation(); maybePresentOnce();
  if(!state.slots.suburb) addMsg('ai','If you share your suburb or VIC postcode (e.g., 3000‚Äì3999), I‚Äôll show the nearest City of Melbourne drop-off and continue.');
});
function looksLikeLocationText(text){
  if(!text) return false;
  if (VIC_POSTCODE_RE.test(text)) return true;       // 3xxx postcode
  const t = text.toLowerCase();
  return COM_SUBURBS.some(s => t.includes(s.toLowerCase())); // any CoM suburb name
}
async function handleSubmit(rawText,imageDataUrl){
  state.flags.justListedEligible=false; state.flags.mappedPostcode=null;
  const text=(rawText||'').trim(); if(!text && !imageDataUrl) return; if(text) addMsg('me', text);
  if(imageDataUrl){ state.slots.item=null; state.slots.size=null; state.presentedKey=null; }
  if(text){
    const t=text.toLowerCase();
    if(ALIAS_TABLE.some(k=>k.re.test(t))){ state.slots.item=null; state.slots.size=null; state.presentedKey=null; }
    consumeUserText(text);
  }
  if (text && looksLikeLocationText(text)) { await handleVicOutsideCOM(text); }
  let model=null;
  if(imageDataUrl){ showImagePreview(imageDataUrl,'Uploaded Image'); model=await callWorker(text,imageDataUrl); mergeModel(model,true); }
  else if(!state.slots.suburb || !state.suburbLocked){ model=await callWorker(text,null); mergeModel(model,false); }
  if(!state.slots.item && text){ const fb=fallbackCategoryAndSize(text); state.slots.item=fb.item; if(!state.slots.size) state.slots.size=fb.size; }
  if(!state.slots.size && state.slots.item) state.slots.size=CATS[state.slots.item]?.def || 'small';
  const missing=[]; if(!state.slots.item) missing.push('item/category'); if(!state.slots.size) missing.push('size (Small/Medium/Large)'); if(!state.slots.suburb) missing.push('City of Melbourne suburb');
  renderSlots();
  if(missing.length){
    if(state.flags.justListedEligible){ return; }
    const pc=(text.match(VIC_POSTCODE_RE)||[])[0];
    if(pc && !postcodeToComSuburb(pc)){ addMsg('ai', `Postcode <strong>${pc}</strong> is not in the City of Melbourne. Please choose one of: <span class="strong">${COM_SUBURBS.join(', ')}</span>.`); return; }
    addMsg('ai','Please provide: ' + missing.join(', ') + '.'); return;
  }
  maybePresentOnce();
}
function showImagePreview(dataUrl,name='image'){ addMsg('me', `<div class="imgthumb"><img src="${dataUrl}" alt="Uploaded Image"/><div>${name}</div></div>`); }
async function useMyLocation(){ if(!navigator.geolocation){ el('locHint').textContent="Geolocation isn‚Äôt supported in this browser."; return; } el('locHint').textContent="Locating‚Ä¶"; el('locate').disabled=true; const getPos=()=>new Promise((resolve,reject)=>navigator.geolocation.getCurrentPosition(resolve,reject,{enableHighAccuracy:true,timeout:15000})); try{ const pos=await getPos(); const {latitude:lat,longitude:lng}=pos.coords; const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=14&addressdetails=1`; const res=await fetch(url,{headers:{'Accept':'application/json'}}); if(!res.ok) throw new Error(`Reverse-geocode failed: ${await res.text()}`); const data=await res.json(); const a=data.address||{}; const candidates=[a.suburb,a.neighbourhood,a.city_district,a.town,a.city,a.village,a.state_district].filter(Boolean); const match=candidates.map(c=>c.trim()).map(c=>(/(cbd|central business district)/i.test(c)?'Melbourne':c)).find(c=>COM_SUBURBS.some(s=>s.toLowerCase()===c.toLowerCase())); if(match){ const proper=COM_SUBURBS.find(s=>s.toLowerCase()===match.toLowerCase()); const prev=state.slots.suburb; state.slots.suburb=proper; state.suburbLocked=true; renderSlots(); addMsg('ai', `Location detected: <strong>${proper}</strong>.`); if(prev && prev!==proper) addMsg('ai', `Noted ‚Äî updating suburb from ${prev} to ${proper}.`); }else{ state.slots.suburb=null; state.suburbLocked=false; renderSlots(); addMsg('ai','Your current location is <strong>not within the City of Melbourne</strong>. Please choose one of: <span class="strong">'+COM_SUBURBS.join(', ')+'</span>.'); } el('locHint').textContent=""; }catch(err){ el('locHint').textContent=(err && err.message)?err.message:"Couldn‚Äôt get your location."; }finally{ el('locate').disabled=false; } }
function resizeImage(file,maxDim){ return new Promise((resolve)=>{ const img=new Image(); img.onload=()=>{ const scale=Math.min(maxDim/img.width,maxDim/img.height,1); const w=Math.round(img.width*scale), h=Math.round(img.height*scale); const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h); resolve(c.toDataURL('image/jpeg',0.72)); }; const r=new FileReader(); r.onload=()=> img.src=r.result; r.readAsDataURL(file); }); }

/* ------------------------------
   QUICK MENU logic
---------------------------------- */
const formEl = document.getElementById('formView');
const catGrid = document.getElementById('catGrid');
const qCategory = document.getElementById('qCategory'); // hidden input
const qSubmit = document.getElementById('qSubmit');
const qReset = document.getElementById('qReset');
const qResults = document.getElementById('qResults');
const qSuburbSel = document.getElementById('qSuburbSel');
const errCat = document.getElementById('errCat');
const errSize = document.getElementById('errSize');
const errSuburb = document.getElementById('errSuburb');

function sortedCatIds(){ return [...CAT_IDS].sort((a,b)=> labelFor(a).localeCompare(labelFor(b))); }
function buildCategoryGrid(){
  catGrid.innerHTML = '';
  for(const id of sortedCatIds()){
    const btn = document.createElement('button');
    btn.type='button';
    btn.className='cat';
    btn.dataset.cat=id;
    btn.textContent=labelFor(id);
    btn.addEventListener('click', ()=>{
      // clear actives
      for(const el of catGrid.querySelectorAll('.cat')) el.classList.remove('active');
      btn.classList.add('active');
      qCategory.value = id;
      setSizeRadios(CATS[id].def);
    });
    catGrid.appendChild(btn);
  }
}
function setSizeRadios(val){
  for(const r of document.querySelectorAll('input[name="qSize"]')) r.checked = (r.value===val);
}
function getCheckedSize(){ const r=document.querySelector('input[name="qSize"]:checked'); return r ? r.value : null; }
function populateSuburbs(){
  qSuburbSel.innerHTML = `<option value="">Choose suburb‚Ä¶</option>` + COM_SUBURBS.map(s=>`<option value="${s}">${s}</option>`).join('');
}
function prefillQuickMenu(){
  // category
  if(state.slots.item){
    const target = catGrid.querySelector(`.cat[data-cat="${state.slots.item}"]`);
    if(target) { target.click(); }
  } else {
    // default select first alphabetically
    const first = catGrid.querySelector('.cat'); if(first) first.click();
  }
  // size
  setSizeRadios(state.slots.size || CATS[qCategory.value]?.def || 'small');
  // suburb
  let sub = state.slots.suburb;
  if(!sub){ try{ sub = localStorage.getItem('ewh_last_suburb') || ''; }catch(_){ } }
  if(sub){ qSuburbSel.value = sub; }
}
function validateQuickMenu(){
  let ok=true;
  errCat.hidden = !!qCategory.value; if(!qCategory.value) ok=false;
  const sizeVal = getCheckedSize(); errSize.hidden = !!sizeVal; if(!sizeVal) ok=false;
  errSuburb.hidden = !!qSuburbSel.value; if(!qSuburbSel.value) ok=false;
  return { ok, sizeVal, suburb:qSuburbSel.value };
}
function renderFormResults(categoryId, size, suburb){
  const council = nearbyCouncilSites(categoryId, suburb);
  const councilList = council.map(x => `
    <div class="site">
      <div><strong>${x.name}</strong></div>
      <div>${x.address}</div>
      <div><a href="${gmapsLink(x.lat,x.lng,x.name)}" target="_blank" rel="noopener"><strong>Open in Google Maps</strong></a></div>
    </div>`).join('');
  let retailBlock='';
  if(isBatteryish(categoryId)){
    const ref={lat:council[0]?.lat ?? -37.8165, lng:council[0]?.lng ?? 144.9652};
    const retail=nearbyRetailSites(ref.lat,ref.lng,5);
    if(retail.length){
      const retailList=retail.map(r=>`
        <div class="site">
          <div><strong>${r.brand} ‚Äî ${r.name || r.suburb}</strong><span class="retail-badge">Retail battery drop-off</span></div>
          <div>${r.address}</div>
          <div><a href="${gmapsLink(r.lat,r.lng,r.name||r.brand)}" target="_blank" rel="noopener"><strong>Open in Google Maps</strong></a></div>
        </div>`).join('');
      retailBlock = `<div class="section-title">Retail battery drop-off near ${suburb}</div>${retailList}`;
    }
  }
  qResults.innerHTML = `
    <div class="section-title">Closest drop-off options for <strong>${labelFor(categoryId)}</strong> (${capWord(size)}) ‚Äî <strong>${suburb}</strong></div>
    ${councilList || '<div class="hint">No matching City of Melbourne sites found in dataset.</div>'}
    ${retailBlock}
    <div class="hint" style="margin-top:8px">${safetyBlurb(categoryId, size)}</div>
    ${linksFooter()}
  `;
  try{ if(suburb) localStorage.setItem('ewh_last_suburb', suburb); }catch(_){}
}
document.getElementById('qSubmit').addEventListener('click', ()=>{
  const {ok, sizeVal, suburb} = validateQuickMenu();
  if(!ok) return;
  renderFormResults(qCategory.value, sizeVal, suburb);
});
document.getElementById('qReset').addEventListener('click', ()=>{
  buildCategoryGrid(); populateSuburbs(); prefillQuickMenu(); qResults.innerHTML='';
});

/* ------------------------------
   View toggle + init
---------------------------------- */
const chatView = document.getElementById('chatView');
const formView = document.getElementById('formView');
const toggleBtn = document.getElementById('toggleViewBtn');
function showView(which){
  if(which==='form'){
    chatView.hidden=true; formView.hidden=false;
    toggleBtn.textContent='‚óÇ Chat'; toggleBtn.setAttribute('aria-pressed','true'); location.hash='#form';
    if(!catGrid.children.length){ buildCategoryGrid(); populateSuburbs(); prefillQuickMenu(); }
  }else{
    chatView.hidden=false; formView.hidden=true;
    toggleBtn.textContent='Quick Menu ‚ñ∏'; toggleBtn.setAttribute('aria-pressed','false'); location.hash='#chat';
  }
}
toggleBtn.addEventListener('click', ()=> showView(formView.hidden ? 'form' : 'chat'));
function initViewFromHash(){
  if(location.hash==='#form'){ showView('form'); } else { showView('chat'); }
}
initViewFromHash();

/* chat helpers */
function showImagePreview(dataUrl,name='image'){ addMsg('me', `<div class="imgthumb"><img src="${dataUrl}" alt="Uploaded Image"/><div>${name}</div></div>`); }
</script>
</body>
</html>
